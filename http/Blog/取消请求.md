## [AbortController](https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController)

AbortController æŽ¥å£è¡¨ç¤ºä¸€ä¸ªæŽ§åˆ¶å™¨å¯¹è±¡ï¼Œå…è®¸ä½ æ ¹æ®éœ€è¦ä¸­æ­¢**ä¸€ä¸ª**æˆ–**å¤šä¸ª** Web è¯·æ±‚ã€‚

> [å…¼å®¹æ€§](https://caniuse.com/?search=AbortController) ï¼šPC ç«¯åªæœ‰ `IE` ä¸æ”¯æŒï¼›ç§»åŠ¨ç«¯ `Opera Mini` æ‰€æœ‰ç‰ˆæœ¬éƒ½ä¸æ”¯æŒ, `UC Browser for Android` > 12.12, `QQ Browser` > 10.4 ...

## [Fetch API å®žçŽ°](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)

- ç®€å•å°è£…ä¸€ä¸ªç”Ÿæˆä¸­æ–­æŽ§åˆ¶å™¨çš„æ–¹æ³•

```js
function setAbortController() {
  var controller = new AbortController();
  var signal = controller.signal;
  var cancel = function () {
    controller.abort();
  };

  return { signal, cancel };
}
```

ðŸŒ¡ **æ³¨æ„ï¼š**å½“ `abort()` è¢«è°ƒç”¨æ—¶ï¼Œè¿™ä¸ª `fetch()` promise å°† `reject` ä¸€ä¸ªåä¸º `AbortError` çš„ [DOMException](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMException)ã€‚

```js
// define å®šä¹‰
function query(options) {
  const { signal, abort } = setAbortController();

  const request = fetch(url, {
    signal,
    method: "POST",
    body: JSON.stringify(options),
    headers: { "Content-Type": "application/json;charset=UTF-8" },
  }).then((res) => {
    if (res.status === 200) return res.json();
    throw new Error();
  });

  return { request, abort };
}

// å‘èµ·è¯·æ±‚å¹¶ç¼“å­˜abort
const { request, abort } = query(params);
this.abortRequest = abort; // ç¼“å­˜ abort æ–¹æ³•
request
  .then((data) => {
    console.log("data:", data);
    this.abortRequest = null;
  })
  .catch((error) => {
    if (error.code === 20) {
      // è¡¨ç¤ºå·²è¢«ä¸­æ–­
      console.log("error code:", error.code);
      console.log("error message:", error.message);
      console.log("error name:", error.name);
    }
  });

// callback è°ƒç”¨
if (this.abortRequest instanceof Function) {
  this.abortRequest();
  this.abortRequest = null;
}
```

ðŸ¤” **Questionsï¼š**ä¸Šè¿°å†…å®¹ä½¿ç”¨çš„æ˜¯ [Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)ï¼Œé‚£ [XMLHttpRequest](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest) å¦‚ä½•å®žçŽ°?

## [XMLHttpRequest å®žçŽ°](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)

- åˆ›å»º xhr å®žä¾‹çš„å…¼å®¹æ€§å†™æ³•

```js
function createXHR() {
  var xhr;

  if (typeof XMLHttpRequest != "undefined") {
    xhr = new XMLHttpRequest();
  } else {
    var aVersions = [
      "Msxml2.XMLHttp.5.0",
      "Msxml2.XMLHttp.4.0",
      "Msxml2.XMLHttp.3.0",
      "Msxml2.XMLHttp",
      "Microsoft.XMLHttp",
    ];
    for (var i = 0; i < aVersions.length; i++) {
      try {
        xmlHttp = new ActiveXObject(aVersions[i]);
        break;
      } catch (e) {}
    }
  }

  return xhr;
}
```

ðŸŒ¡ **æ³¨æ„ï¼š** 1. ä½¿ç”¨ XHRHttpRequest ä¸­æ–­è¯·æ±‚ï¼Œç›´æŽ¥è°ƒç”¨ abort æ–¹æ³•å³å¯ï¼›2.ç›‘å¬ä¸­æ–­ä½¿ç”¨ onabort äº‹ä»¶ã€‚

```js
var url = "http://127.0.0.1:3008/user";
var abortXHR;

// å‘èµ·è¯·æ±‚
function startXMLHttpRequest() {
  var xhr = createXHR();
  if (xhr) {
    xhr.onreadystatechange = function () {
      if (
        xhr.readyState === XMLHttpRequest.DONE /* 4 */ &&
        xhr.status === 200
      ) {
        var data = JSON.parse(xhr.responseText);
        console.log(data);
      }
    };

    xhr.open("GET", url);

    abortXHR = function () {
      xhr.abort();
    };

    xhr.onabort = function () {
      //   console.log(xhr.readyState); // 4
      //   console.log(xhr.status); // 0

      // * æ³¨æ„è¿™é‡Œçš„readyStateå€¼çš„æ›´æ–°æ—¶é—´
      // setTimeout(() => {
      //   console.log(xhr.readyState); // 0
      //   console.log(xhr.status); // 0
      // }, 0);

      alert("XMLHttpRequest Aborted!");
    };

    xhr.send();
  }
}

// ä¸­æ–­è¯·æ±‚
function abortXMLHttpRequest() {
  if (abortFetchRequest instanceof Function) {
    abortFetchRequest();
    abortFetchRequest = null;
  }
}

startXMLHttpRequest();
```
